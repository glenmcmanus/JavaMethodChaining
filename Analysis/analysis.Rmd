---
title: "Analysis"
output: html_document
---

```{r libraries}

library(tidyverse)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data}

f <- read.csv(file = '../Parser/method_chaining_results.csv')

```

```{r clean data}

f <- f[!(f$LongestChain == -1),]

```

```{r find repos with longest chains}
S_bin <- f %>% filter(f$LongestChain > 1 & f$LongestChain <= 8)
S_bin
L_bin <- f %>% filter(f$LongestChain > 8 & f$LongestChain < 42)
L_bin
XL_bin <- f %>% filter(f$LongestChain >= 42)
XL_bin
f %>% filter(f$LongestChain >= 100)
f %>% filter(f$LongestChain >= 200)
f %>% filter(f$LongestChain >= 300)


```

```{r bin_stats funct}
bin_stats <- function(bin, bin_lower, bin_upper) {
  tmp <- bin[, bin_lower:bin_upper]
  tmp <- colSums(tmp, na.rm = TRUE)
  tmp_pop <- sum(tmp)
  tmp_mu <- sum(colSums(bin[,5:bin_upper]) * seq(2,bin_upper-3)) / sum(bin[,5:bin_upper])
  tmp_bin_mu <- sum(tmp * seq(bin_lower-3,bin_upper-3)) / sum(tmp)
  
  tmp_bin_sd <- 0
  for(i in 1:length(tmp)) {
        tmp_bin_sd <- tmp_bin_sd + ((i - tmp_bin_mu))^2 * tmp[i]
  }
  tmp_bin_sd <- tmp_bin_sd / tmp_pop
  
  tmp_sd <- 0
  for(i in 5:bin_upper) {
        tmp_sd <- tmp_sd + ((i - 3 - tmp_mu))^2 * sum(bin[,i])
  }
  tmp_sd <- tmp_sd / sum(bin[,5:bin_upper])
  
  tmp_ratio <- dim(bin)[1] / dim(f)[1]
  return(c(tmp_ratio, dim(bin)[1], tmp_mu,  tmp_bin_mu, sqrt(tmp_sd), sqrt(tmp_bin_sd)))
}

size_bins <- data.frame(row.names = c("count_ratio", "repo_count", "mean_chain_length", "bin_mean_chain_length", "chain_length_sd", "bin_chain_length_sd"))
size_bins$S <- bin_stats(S_bin, 5, 11)
size_bins$L <- bin_stats(L_bin, 12, 45)
size_bins$xL <- bin_stats(XL_bin, 46, 403)
size_bins
```

```{r relative_occurrence (fn)}

relative_occurrence <- f

relative_occurrence[ , 5:403] <- f[ , 5:403] / f[ , 4]

relative_occurrence <- select(relative_occurrence, -LongestChain, -Length.0, -Length.1)

```

```{r clean relative_occurrence}

relative_occurrence <- relative_occurrence[!(is.nan(relative_occurrence$Length.2) | relative_occurrence$Length.2 == Inf), ]

```

```{r fn}

fn <- data.frame(row.names = c(1:400))
fn$n <- c(1:400)
#fn$count <- c(2:400)
fn$relative_occurrence <- c(1:400)

for(i in 1:nrow(fn)) {
  #fn[i,1] <- sum(na.omit(f[, i + 4]))
  fn[i,2] <- mean(na.omit(relative_occurrence[, i]))
}

fn <- fn[-1,]

```

```{r plot fn}
p <- ggplot(fn, aes(n, relative_occurrence))
p + geom_point() + scale_y_log10() + scale_x_log10()
```

```{r ratio}

ratio <- f
ratio <- select(ratio, Repo)

ratio$r <- f[ , 3]
for(i in 0:nrow(ratio)) {
  ratio[i, 2] <- sum(f[i, 5:403]) / sum(f[i, 3:403])  
}
```

```{r ratio histogram}

a <- ggplot(ratio, aes(x = r))

a + geom_histogram(color = "black", fill = "red")

```

```{r mc_bins}
mc_binned <- data.frame(row.names = c("Short", "Long", "ExtLong"))
mc_binned$num_chains_2019_2020 <- c(sum(f[,5:11]), sum(f[,12:44]), sum(f[,45:403]))
```